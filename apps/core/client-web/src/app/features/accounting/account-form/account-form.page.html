<div class="view-container">
  <form [formGroup]="accountForm" (ngSubmit)="onSave()">
    <div class="view-header">
      <div class="header-content">
        <h1>{{ isEditing() ? 'Editar Cuenta Contable' : 'Nueva Cuenta Contable' }}</h1>
        <p>Completa la información detallada de la cuenta.</p>
      </div>
      <div class="header-actions">
        <button type="button" class="secondary-button" (click)="onCancel()">Cancelar</button>
        <button type="submit" class="primary-button" [disabled]="isLoading() || accountForm.invalid">
          @if (isLoading()) {
            <span class="spinner"></span>
            <span>Guardando...</span>
          } @else {
            <lucide-icon [img]="SaveIcon" size="16"></lucide-icon>
            <span>Guardar Cuenta</span>
          }
        </button>
      </div>
    </div>

    @if (isLoading()) {
      <p class="loading-state">Cargando datos de la cuenta...</p>
    } @else {
      <div class="form-container card">
        <div class="tabs">
          <button type="button" class="tab-link" [class.active]="activeTab() === 'general'" (click)="activeTab.set('general')">General</button>
          <button type="button" class="tab-link" [class.active]="activeTab() === 'mappings'" (click)="activeTab.set('mappings')">Mapeos</button>
          <button type="button" class="tab-link" [class.active]="activeTab() === 'rules'" (click)="activeTab.set('rules')">Reglas</button>
          <button type="button" class="tab-link" [class.active]="activeTab() === 'advanced'" (click)="activeTab.set('advanced')">Avanzado</button>
        </div>

        <div class="tab-content">
          @if (activeTab() === 'general') {
            <section class="form-grid">
              <div class="form-field">
                <label for="code">Código de Cuenta*</label>
                <input id="code" formControlName="code" [readonly]="isEditing()">
              </div>
              <div class="form-field">
                <label for="name">Nombre de la Cuenta*</label>
                <input id="name" formControlName="name">
              </div>
              <div class="form-field full-width">
                <label for="description">Descripción</label>
                <textarea id="description" formControlName="description" rows="3"></textarea>
              </div>
              <div class="form-field">
                <label for="parentId">Cuenta Padre (Agrupadora)</label>
                <select id="parentId" formControlName="parentId">
                  <option [ngValue]="null">-- Ninguna (Cuenta Raíz) --</option>
                  @for (opt of stateService.parentAccountOptions(); track opt.id) {
                    <option [value]="opt.id">{{ opt.code }} - {{ opt.name }}</option>
                  }
                </select>
              </div>
              <div class="form-field">
                <label for="type">Tipo de Cuenta*</label>
                <select id="type" formControlName="type" [attr.disabled]="isEditing() ? true : null">
                  <option [ngValue]="null" disabled>Seleccionar tipo...</option>
                  @for (type of accountTypes; track type) {
                    <option [value]="type">{{ type }}</option>
                  }
                </select>
              </div>
               <div class="form-field">
                <label for="nature">Naturaleza (Automático)</label>
                <input id="nature" formControlName="nature" readonly>
              </div>
              <div class="form-field">
                <label for="category">Categoría*</label>
                <select id="category" formControlName="category">
                  <option [ngValue]="null" disabled>Seleccionar categoría...</option>
                  @for (cat of accountCategories; track cat) {
                    <option [value]="cat">{{ cat }}</option>
                  }
                </select>
              </div>
              <div class="form-field checkbox-field">
                <input id="isPostable" type="checkbox" formControlName="isPostable">
                <label for="isPostable">Es una cuenta imputable (permite transacciones)</label>
              </div>
              <div class="form-field checkbox-field">
                <input id="isActive" type="checkbox" formControlName="isActive">
                <label for="isActive">Cuenta activa</label>
              </div>
            </section>
          }

          @if (activeTab() === 'mappings') {
            <section formGroupName="statementMapping">
              <h3>Mapeo de Estados Financieros</h3>
              <p class="section-description">Define cómo se representa esta cuenta en los reportes financieros clave.</p>
              <div class="form-grid">
                <div class="form-field">
                  <label for="balanceSheetCategory">Categoría de Balance General</label>
                  <input id="balanceSheetCategory" formControlName="balanceSheetCategory" placeholder="Ej: Activos Circulantes">
                </div>
                <div class="form-field">
                  <label for="incomeStatementCategory">Categoría de Estado de Resultados</label>
                  <input id="incomeStatementCategory" formControlName="incomeStatementCategory" placeholder="Ej: Ingresos Operativos">
                </div>
                <div class="form-field">
                  <label for="cashFlowCategory">Categoría de Flujo de Efectivo</label>
                  <select id="cashFlowCategory" formControlName="cashFlowCategory">
                    @for (cat of cashFlowCategories; track cat) {
                      <option [value]="cat">{{ cat | titlecase }}</option>
                    }
                  </select>
                </div>
              </div>
            </section>
          }

          @if (activeTab() === 'rules') {
            <section formGroupName="rules">
              <h3>Reglas de Contabilización</h3>
              <p class="section-description">Establece restricciones y comportamientos específicos para esta cuenta.</p>
              <div class="form-grid">
                  <div class="form-field checkbox-field"><input type="checkbox" id="requiresReconciliation" formControlName="requiresReconciliation"><label for="requiresReconciliation">Requiere Reconciliación</label></div>
                  <div class="form-field checkbox-field"><input type="checkbox" id="isCashOrBank" formControlName="isCashOrBank"><label for="isCashOrBank">Es Cuenta de Caja o Banco</label></div>
                  <div class="form-field checkbox-field"><input type="checkbox" id="allowsIntercompany" formControlName="allowsIntercompany"><label for="allowsIntercompany">Permite Transacciones Intercompañía</label></div>
                  <div class="form-field checkbox-field"><input type="checkbox" id="isFxRevaluation" formControlName="isFxRevaluation"><label for="isFxRevaluation">Aplica Revaluación por Tipo de Cambio</label></div>
              </div>
              <div class="form-field full-width" formArrayName="requiredDimensions">
                  <label>Dimensiones Requeridas</label>
                  <div class="checkbox-group">
                      @for(dim of allDimensions; track dim; let i = $index){
                          <div class="checkbox-item">
                              <input type="checkbox" [id]="'dim-' + i" [value]="dim" [checked]="isDimensionSelected(dim)" (change)="onDimensionChange($event)">
                              <label [for]="'dim-' + i">{{ dim | titlecase }}</label>
                          </div>
                      }
                  </div>
              </div>
            </section>
          }
          
          @if (activeTab() === 'advanced') {
            <section formGroupName="advanced">
                <h3>Configuración Avanzada</h3>
                <p class="section-description">Parámetros de control y auditoría para la cuenta.</p>
                <div class="form-grid">
                    <div class="form-field">
                        <label for="version">Versión del Catálogo</label>
                        <input id="version" type="number" formControlName="version">
                    </div>
                    <div class="form-field">
                        <label for="hierarchyType">Tipo de Jerarquía</label>
                        <input id="hierarchyType" formControlName="hierarchyType">
                    </div>
                    <div class="form-field">
                        <label for="effectiveFrom">Vigente Desde</label>
                        <input id="effectiveFrom" type="date" formControlName="effectiveFrom">
                    </div>
                    <div class="form-field">
                        <label for="effectiveTo">Vigente Hasta</label>
                        <input id="effectiveTo" type="date" formControlName="effectiveTo">
                    </div>
                </div>
            </section>
          }

        </div>
      </div>
    }
  </form>
</div>