<div class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            @if (userName) {
                <h1 class="auth-title">¡Hola, {{ userName }}!</h1>
                <p class="auth-subtitle">Define una contraseña para activar tu cuenta y empezar a colaborar.</p>
            } @else {
                <h1 class="auth-title">Crea tu Contraseña</h1>
                <p class="auth-subtitle">Casi listo. Solo necesitas una contraseña segura.</p>
            }
        </div>

        @if (token && !errorMessage) {
            <form [formGroup]="setPasswordForm" (ngSubmit)="onSubmit()" class="auth-form">
                <div formGroupName="passwordGroup">
                    <div class="form-field" [class.error]="passwordGroup.get('password')?.invalid && passwordGroup.get('password')?.touched">
                        <label for="password" class="input-label">Nueva Contraseña</label>
                        <div class="input-wrapper">
                            <lucide-icon [img]="LockIcon" size="18" class="input-icon"></lucide-icon>
                            <input id="password" [type]="passwordVisible ? 'text' : 'password'" formControlName="password"
                                placeholder="Mínimo 8 caracteres" (focus)="showPasswordHints = true" (blur)="onPasswordBlur()">
                            <button type="button" class="toggle-password" (click)="passwordVisible = !passwordVisible" aria-label="Mostrar/Ocultar contraseña">
                                <lucide-icon [img]="passwordVisible ? EyeOffIcon : EyeIcon" size="18"></lucide-icon>
                            </button>
                        </div>

                        @if (showPasswordHints) {
                        <div class="password-hints-popup">
                            <p [class.valid]="passwordValue.length >= 8">
                                <lucide-icon [img]="passwordValue.length >= 8 ? CheckIcon : XIcon" size="16"></lucide-icon> Al menos 8 caracteres
                            </p>
                            <p [class.valid]="hasLowerCase(passwordValue)">
                                <lucide-icon [img]="hasLowerCase(passwordValue) ? CheckIcon : XIcon" size="16"></lucide-icon> Una letra minúscula
                            </p>
                            <p [class.valid]="hasUpperCase(passwordValue)">
                                <lucide-icon [img]="hasUpperCase(passwordValue) ? CheckIcon : XIcon" size="16"></lucide-icon> Una letra mayúscula
                            </p>
                            <p [class.valid]="hasNumber(passwordValue)">
                                <lucide-icon [img]="hasNumber(passwordValue) ? CheckIcon : XIcon" size="16"></lucide-icon> Un número
                            </p>
                            <p [class.valid]="hasSpecialChar(passwordValue)">
                                <lucide-icon [img]="hasSpecialChar(passwordValue) ? CheckIcon : XIcon" size="16"></lucide-icon> Un símbolo
                            </p>
                        </div>
                        }
                    </div>

                    <div class="form-field" [class.error]="passwordGroup.hasError('passwordMismatch') || (passwordGroup.get('confirmPassword')?.invalid && passwordGroup.get('confirmPassword')?.touched)">
                        <label for="confirmPassword" class="input-label">Confirmar Contraseña</label>
                        <div class="input-wrapper">
                            <lucide-icon [img]="LockIcon" size="18" class="input-icon"></lucide-icon>
                            <input id="confirmPassword" [type]="confirmPasswordVisible ? 'text' : 'password'"
                                formControlName="confirmPassword" placeholder="Confirma tu nueva contraseña">
                            <button type="button" class="toggle-password" (click)="confirmPasswordVisible = !confirmPasswordVisible" aria-label="Mostrar/Ocultar contraseña">
                                <lucide-icon [img]="confirmPasswordVisible ? EyeOffIcon : EyeIcon" size="18"></lucide-icon>
                            </button>
                        </div>
                        @if (passwordGroup.hasError('passwordMismatch') && passwordGroup.get('confirmPassword')?.touched) {
                        <div class="error-message">Las contraseñas no coinciden.</div>
                        }
                    </div>
                </div>

                <button type="submit" class="submit-button" [disabled]="isLoading" [class.loading]="isLoading">
                    @if(isLoading){ <span class="spinner"></span> }
                    <span>Activar Cuenta y Entrar</span>
                </button>
            </form>
        }

        @if (errorMessage) {
        <div class="error-message global-error" role="alert">
            <lucide-icon [img]="AlertCircleIcon" size="16"></lucide-icon>
            <span>{{ errorMessage }}</span>
        </div>
        }
    </div>
</div>