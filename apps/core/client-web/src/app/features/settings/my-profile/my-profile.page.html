<div class="settings-page-container">
  <div class="page-header">
    <h2>Mi Perfil</h2>
    <p class="text-secondary">Administra tu información personal y configuración de seguridad.</p>
  </div>

  <div class="profile-layout">
    <!-- Información Personal -->
    <div class="settings-section">
      <div class="section-header">
        <h3>Información Personal</h3>
        <p>Actualiza tus datos de contacto y rol.</p>
      </div>

      <div class="card">
        <div class="card-body">
          <form [formGroup]="profileForm" (ngSubmit)="saveProfile()">

            <div class="profile-header">
              <div class="avatar-upload">
                 <input
                  type="file"
                  id="avatarUrl"
                  (change)="onFileSelected($event)"
                  accept="image/png, image/jpeg"
                />
                <label for="avatarUrl" class="avatar-label">
                   @if(avatarPreview()){
                    <img
                      [src]="avatarPreview()"
                      alt="Avatar"
                      class="avatar-image"
                    />
                    <div class="avatar-overlay">
                      <lucide-icon [img]="ImageIcon" size="20"></lucide-icon>
                    </div>
                  } @else {
                    <div class="avatar-placeholder">
                       <lucide-icon [img]="ImageIcon" size="24"></lucide-icon>
                    </div>
                  }
                </label>
              </div>
              <div class="profile-info-text">
                <h4>Foto de Perfil</h4>
                <p>Formatos permitidos: JPG, PNG. Máximo 2MB.</p>
              </div>
            </div>

            <div class="form-grid">
              <div class="form-field">
                <label for="firstName">Nombre</label>
                <input id="firstName" type="text" formControlName="firstName" class="form-input" placeholder="Tu nombre" />
              </div>
              <div class="form-field">
                <label for="lastName">Apellido</label>
                <input id="lastName" type="text" formControlName="lastName" class="form-input" placeholder="Tu apellido" />
              </div>
            </div>

            <div class="form-field">
              <label for="email">Correo Electrónico</label>
              <input id="email" type="email" formControlName="email" class="form-input" readonly />
              <span class="help-text">El correo electrónico no se puede cambiar.</span>
            </div>

            <div class="form-grid">
              <div class="form-field">
                <label for="phone">Teléfono</label>
                <div class="flex gap-2">
                    <input id="phone" type="tel" formControlName="phone" class="form-input" placeholder="+1 (000) 000-0000" />
                    @if (!currentUser()?.isPhoneVerified) {
                        <button type="button" (click)="openPhoneVerification()" class="px-4 py-2 bg-yellow-500/10 text-yellow-500 rounded-xl hover:bg-yellow-500/20 text-sm font-medium whitespace-nowrap">
                            Verificar
                        </button>
                    } @else {
                        <div class="flex items-center gap-2 px-4 py-2 bg-green-500/10 text-green-500 rounded-xl">
                            <span class="text-sm font-medium">Verificado</span>
                        </div>
                    }
                </div>
              </div>
              <div class="form-field">
                <label for="jobTitle">Cargo</label>
                <input id="jobTitle" type="text" formControlName="jobTitle" class="form-input" placeholder="Ej. Gerente de Ventas" />
              </div>
            </div>

            <div class="form-actions">
              <button
                type="submit"
                class="btn btn-primary"
                [disabled]="profileForm.pristine || profileForm.invalid"
              >
                <lucide-icon [img]="SaveIcon" size="18"></lucide-icon>
                <span>Guardar Cambios</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Seguridad -->
    <div class="settings-section">
      <div class="section-header">
        <h3>Seguridad</h3>
        <p>Gestiona tu contraseña y acceso.</p>
      </div>

      <div class="card">
        <div class="card-body">
          <form [formGroup]="passwordForm" (ngSubmit)="changePassword()">
            <div class="form-field">
              <label for="currentPassword">Contraseña Actual</label>
              <input
                id="currentPassword"
                type="password"
                formControlName="currentPassword"
                class="form-input"
                autocomplete="current-password"
              />
            </div>

            <div class="form-grid">
              <div class="form-field">
                <label for="newPassword">Nueva Contraseña</label>
                <input
                  id="newPassword"
                  type="password"
                  formControlName="newPassword"
                  class="form-input"
                  autocomplete="new-password"
                />
              </div>
              <div class="form-field">
                <label for="confirmPassword">Confirmar Contraseña</label>
                <input
                  id="confirmPassword"
                  type="password"
                  formControlName="confirmPassword"
                  class="form-input"
                  autocomplete="new-password"
                />
              </div>
            </div>

            <div class="form-actions">
              <button
                type="submit"
                class="btn btn-primary"
                [disabled]="passwordForm.invalid"
              >
                <lucide-icon [img]="SaveIcon" size="18"></lucide-icon>
                <span>Actualizar Contraseña</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Phone Verification Modal -->
@if (showPhoneModal()) {
    <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
        <div class="bg-card-bg border border-border-color rounded-2xl shadow-xl w-full max-w-md p-6 space-y-6">
            <div class="text-center">
                <h3 class="text-xl font-bold text-text-primary">Verificar Teléfono</h3>
                <p class="text-text-secondary text-sm mt-1">Ingresa tu número de teléfono para recibir un código SMS.</p>
            </div>

            <div class="space-y-4">
                @if (!otpSent()) {
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-text-secondary">Número de Teléfono</label>
                        <input type="tel" [formControl]="phoneControl" class="w-full form-input" placeholder="+1809...">
                    </div>
                } @else {
                    <div class="space-y-2">
                         <label class="text-sm font-medium text-text-secondary">Código de Verificación</label>
                         <input type="text" [formControl]="otpControl" class="w-full form-input text-center text-2xl tracking-widest" maxlength="6">
                    </div>
                }
            </div>

            <div class="flex gap-3">
                <button (click)="closePhoneVerification()" class="flex-1 px-4 py-2 bg-card-bg hover:bg-hover-bg border border-border-color text-text-primary rounded-xl transition-colors">
                    Cancelar
                </button>
                @if (!otpSent()) {
                    <button (click)="sendPhoneOtp()" [disabled]="phoneControl.invalid || isVerifyingPhone()" class="flex-1 px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-xl transition-colors flex items-center justify-center">
                        @if(isVerifyingPhone()) { <span class="animate-spin mr-2">⏳</span> }
                        Enviar Código
                    </button>
                } @else {
                     <button (click)="verifyPhoneOtp()" [disabled]="otpControl.invalid || isVerifyingPhone()" class="flex-1 px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-xl transition-colors flex items-center justify-center">
                        @if(isVerifyingPhone()) { <span class="animate-spin mr-2">⏳</span> }
                        Verificar
                    </button>
                }
            </div>
        </div>
    </div>
}
